# 《陆地军事塔防》开发计划与技术实现

基于完整GDD的详细技术开发指南，专为抖音小游戏优化。目标：**10-14天solo完成**，使用Godot 4.6.1引擎。

## 🎯 项目目标

- **平台**：抖音小游戏（主包≤4MB，整体≤20MB）
- **目标用户**：碎片时间玩家，单局3-8分钟
- **技术栈**：Godot 4.6.1 + HTML5导出 + 抖音开发者工具
- **美术风格**：16-bit像素风，AI生成SVG矢量图

## 📋 开发前提准备（Day 0）

### 工具安装
1. **Godot 4.6.1** - [godotengine.org](https://godotengine.org/) 下载并安装
2. **抖音开发者工具** - [developer.open-douyin.com](https://developer.open-douyin.com/) 下载V14+
3. **Aseprite** - 像素画制作工具
4. **Leonardo.ai/Ideogram** - AI美术生成工具

### 项目初始化
1. 新建Godot项目：`陆地军事塔防`
2. 设置导出：Project → Export → HTML5
   - Threads: Disabled
   - PCK: Zstd compression
   - 移除不必要的模块

## 🏗️ 技术架构

### Godot节点结构
```
Main (Node2D, CanvasLayer UI)
├── Camera2D (地图拖拽相机)
├── DynamicGrid (地块网格：单格购买土地、背包式占格，支持多格建筑形状)
├── BuildingPool (Node, 预造40个建筑实例)
├── UnitPool (Node, 预造200个单位实例)
├── EnemyTowerPool (Node, 敌方防御塔管理)
├── MapExpansionManager (Node, 地图扩展控制器)
├── UILayer (CanvasLayer)
│   ├── GoldLabel (Label)
│   ├── ShopButtons (4种建筑+移除+单格购地)
│   ├── RelicPopup (ColorRect+按钮组, 暂停游戏)
│   ├── TowerHealthBar (建筑血条显示)
│   ├── SpeedBtn (TouchScreenButton, 加速功能)
│   └── PauseBtn (TouchScreenButton)
└── GameManager (Node, AutoLoad全局脚本)
```
MVP 不实现：TerrainManager、码头、机场。

### 核心脚本框架

#### GameManager.gd (全局游戏管理)
```gdscript
extends Node

# 游戏状态
var gold: int = 2000
var current_region: int = 1
var grid: TileMapLayer
var building_pool: Array = []
var unit_pool: Dictionary = {}  # {type: [instances]}
var enemy_towers: Array = []  # 敌方防御塔列表

func _ready():
    grid = $DynamicGrid
    init_pools()
    init_enemy_towers()

func init_pools():
    # 预造建筑对象池
    for i in 20:
        building_pool.append(preload("res://scenes/Building.tscn").instantiate())

    # 预造单位对象池
    for type in ["infantry", "tank", "artillery"]:
        unit_pool[type] = []
        for i in 50:
            var unit = preload("res://scenes/Unit.tscn").instantiate()
            unit.unit_type = type
            unit_pool[type].append(unit)

func add_gold(amount: int):
    gold += amount
    $UILayer/GoldLabel.text = str(gold)

func init_enemy_towers():
    # 初始化敌方防御塔
    for tower_data in Cfg.enemy_towers.types:
        var tower = preload("res://scenes/EnemyTower.tscn").instantiate()
        tower.init_tower(tower_data)
        enemy_towers.append(tower)
        add_child(tower)

func on_tower_destroyed(tower: Node):
    enemy_towers.erase(tower)
    # 检查是否解锁新地图区域
    check_map_expansion()
```

#### Grid.gd (网格拖拽系统)
```gdscript
extends TileMapLayer

const BUILDING_COSTS = {
    "gold_mine": 50,
    "barracks": 100,
    "cannon_tower": 150,
    "tavern": 200
}

func _input(event):
    if event is InputEventScreenDrag:
        var grid_pos = local_to_map(get_global_mouse_position())
        if can_place_building(grid_pos):
            place_building(get_selected_building_type(), grid_pos)

func can_place_building(pos: Vector2i) -> bool:
    return get_cell_source_id(0, pos) == -1  # 空地检查

func place_building(type: String, pos: Vector2i):
    if GameManager.gold < BUILDING_COSTS[type]:
        return

    set_cell(0, pos, get_building_atlas_id(type), Vector2i.ZERO)
    GameManager.add_gold(-BUILDING_COSTS[type])

    # 激活建筑功能
    match type:
        "gold_mine":
            start_gold_production(pos)
        "barracks":
            start_unit_production(pos, "infantry")
        # ... 其他建筑类型
```

#### Unit.gd (自动战斗单位)
```gdscript
extends Area2D

# 单位由建筑产出，等级取决于建筑等级
var unit_type: int = 0  # INFANTRY / TANK / ARTILLERY
var level: int = 1
var hp: float = 50.0
var damage: float = 15.0
var speed: float = 40.0

func init_unit(type: int, lv: int, pos: Vector2):
    unit_type = type
    level = lv
    position = pos
    _apply_stats()

func _apply_stats():
    var base = GameManager.UNIT_BASE_STATS[unit_type]
    var mult = GameManager.get_level_multiplier(level)
    hp = base["hp"] * mult
    damage = base["damage"] * mult
    speed = base["speed"] * (1.0 + (level - 1) * 0.2)

func _process(delta):
    # 自动前进 + 寻敌攻击（无需玩家操作）
    # 单位等级由产出建筑决定
    pass
```

#### 地块背包玩法与建筑合并
- **土地**：初始少量地块；扩展时**按单格购买**（一块块买，非整排），每格独立定价/解锁。
- **占格规则**：Lv1 建筑占 1 格；升级后占多格，形状固定（如 Lv2 酒馆=田字形 2×2）。配置表定义每建筑每等级的占格形状（shape: 1x1 / 2x2 / 等）。
- **合并升级**：同类型+同等级可合并。升级前**必须手动指定**升级后建筑要占用的多格区域（连续且全部为空，且符合该等级形状），否则无法升级；指定完成后确认合并，源格清空，目标区域变为高等级建筑。

```gdscript
# 示例：Lv2 酒馆 = 田字形 2x2，合并前需先选 4 个空格
func _can_merge_with_placement(from: Vector2i, to_cells: Array[Vector2i], shape: String) -> bool:
    # 同类型+同等级+未满级 + to_cells 全为空且连续且符合 shape
    return ...
```

## 📅 详细开发时间表

### Day 1-2: 项目搭建与核心系统
- **目标**：可运行的基础框架
- **任务**：
  1. 创建Godot项目，设置场景结构
  2. 实现初始少量地块 + **单格购买**土地扩展（一块块买）；网格 90 度旋转
  3. 基础UI：金币显示、商店按钮
  4. 触控拖拽输入系统
  5. 对象池系统搭建
- **里程碑**：空场景运行，网格可拖拽

### Day 3-4: 建筑与单位系统
- **目标**：放置、生产与地块背包基础
- **任务**：
  1. **单格购买土地**：商店/扩展处按格购买，一块块解锁
  2. 建筑放置逻辑（4 种建筑：金矿/兵营/炮台/酒馆，MVP 无码头机场）
  3. 金币生产、单位生产（兵营/酒馆）、相邻 Buff
  4. 基础单位移动与渲染（3 兵种：步兵/坦克/火炮）
- **里程碑**：可单格买地、放置建筑并产出资源

### Day 5-6: 背包式合并与战斗
- **目标**：多格占格 + 手动指定放置的合并
- **任务**：
  1. **多格建筑形状**：配置 Lv2/Lv3 占格（如 Lv2 酒馆=田字形 2×2），合并前需**手动指定**升级后占格（连续且全为空）
  2. 建筑拖拽合并流程：选源→选目标占格区域→确认→升级
  3. 合并视觉特效（缩放+粒子）
  4. 自动战斗（单位视野机制）、3 兵种克制
  5. 敌人 AI（地形系统 MVP 可暂缓）
- **里程碑**：2 个 Lv1 兵营指定 2×2 或 1×2 等目标格后合并为 Lv2 兵营

### Day 7-8: 地图扩展与Roguelike
- **目标**：完整游戏循环
- **任务**：
  1. 敌方防御塔系统（4 种塔类型）
  2. 建筑摧毁机制与血条显示
  3. 地图扩展（单格购地已就绪）+ 解锁新区域
  4. 遗物选择系统（8种遗物，暂停游戏）
  5. 建筑移除功能+加速按钮
- **里程碑**：摧毁8个敌方建筑通关，选遗物生效

### Day 9-10: 美术与优化
- **目标**：完整的视觉体验
- **任务**：
  1. 导入美术资源（SVG→SpriteFrames）
  2. 动画系统（2帧逐帧）
  3. 粒子效果（合并、战斗）
  4. 音效集成（可选）
  5. 性能优化（对象池、MultiMesh）
- **里程碑**：总资源<1MB，60FPS运行

### Day 11-12: 导出与发布准备
- **目标**：抖音小游戏就绪
- **任务**：
  1. HTML5导出配置（分包策略）
  2. 抖音开发者工具集成
  3. 包大小优化（<4MB主包）
  4. 自审报告编写
  5. 真机测试
- **里程碑**：开发者工具预览正常

### Day 13-14: 最终测试与提交
- **目标**：成功发布
- **任务**：
  1. 完整游戏流程测试
  2. 平衡性调整（Excel表格）
  3. Bug修复
  4. 提审资料准备
  5. 提交审核等待
- **里程碑**：审核通过，上线运行

## 🔧 技术优化方案

### 包大小优化
| 优化项目 | 目标 | 技术方案 |
|---------|------|----------|
| 主包大小 | <4MB | SVG矢量图 + 分包加载 |
| 美术资源 | <500KB | AI生成16-bit像素风格 |
| 代码大小 | <300KB | GDScript TreeShaking |
| 加载时间 | <2秒 | 懒加载 + 对象池 |

### 性能优化
- **渲染**：MultiMeshInstance2D批量渲染单位
- **内存**：对象池复用，及时清理
- **FPS**：固定60FPS，禁用不必要模块
- **触控**：TouchScreenButton + 拖拽优化

## 📱 抖音发布流程

1. **开发者平台注册**：个人/企业认证（1天）
2. **项目创建**：选择"抖音小游戏" + Godot引擎
3. **信息完善**：名称、简介、图标设置
4. **导出导入**：Godot HTML5 → 开发者工具
5. **分包配置**：主包代码/UI，分包资源
6. **自审提交**：按模板填写，突出玩法特色
7. **审核等待**：1-7天，通过后自动上线

## 🎯 风险控制

- **审核风险**：避免敏感词，突出"合并推土机"爽点
- **性能风险**：预留50%单位上限，优先保证60FPS
- **大小风险**：美术使用SVG，代码精简
- **兼容风险**：测试各种机型，适配触控操作

## 📊 平衡设计

使用Excel表格管理：
- **单位属性**：HP/伤害/速度随等级指数增长，视野范围随等级增加
- **防御塔属性**：HP/伤害随塔等级递增，位置随机
- **土地**：**单格购买**价格（如首格 100，递增），非整排；背包式地块总数上限可配置
- **地图扩展**：摧毁塔后解锁新区域，金币奖励递增
- **多格建筑**：每建筑每等级占格形状表（如 Lv1=1x1，Lv2 酒馆=2x2 田字形），合并前必须指定目标占格
- **遗物效果**：+20-50%属性提升，选择时暂停游戏
- **建筑效率**：相邻 Buff+20%，移除返还 60%；MVP 不包含码头、机场
- **加速机制**：2x 速度倍率；MVP 地形系统（河流/桥/水域）可暂缓

---

**开发总时长**：35-40小时（兼职1-2周）
**预算**：0元（免费工具）
**成功标准**：摧毁8个敌方建筑<8分钟，合并特效爆炸，视野机制正常，地形阻挡生效，加速暂停功能正常

开始开发，目标是抖音小游戏月入过万！🚀